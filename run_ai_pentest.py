#!/usr/bin/env python3
"""
AI-Powered Penetration Testing System
Integration of Developmental (AI/ML) and Operational (UI/UX) Silos
"""

import sys
import os
import threading
import time
from datetime import datetime

# Add dev directory to path
sys.path.append(os.path.join(os.path.dirname(__file__), 'dev'))

def main():
    """Main entry point for the AI Penetration Testing System"""
    
    print("ğŸ” AI-Powered Penetration Testing System")
    print("=" * 60)
    print("Built with DevOps principles and advanced AI/ML capabilities")
    print("=" * 60)
    
    try:
        # Import AI components
        from dev.ai_core import AICore, AttackType, AttackResult
        from dev.unsupervised_learning import UnsupervisedLearning
        
        print("âœ… Developmental Silo: AI/ML Core loaded")
        
        # Initialize AI components
        ai_core = AICore()
        unsupervised_learning = UnsupervisedLearning()
        
        print("âœ… Unsupervised Learning: Pattern discovery engine loaded")
        
        # Check if UI is available
        try:
            import tkinter as tk
            from tkinter import ttk
            print("âœ… Operational Silo: UI/UX Interface available")
            ui_available = True
        except ImportError:
            print("âš ï¸  UI not available, running in CLI mode")
            ui_available = False
        
        # Start the system
        if ui_available:
            print("ğŸš€ Starting GUI interface...")
            # Import and start GUI
            try:
                from ops.main_interface import ProgressiveLearningInterface
                app = ProgressiveLearningInterface()
                app.run()
            except ImportError:
                print("âš ï¸  GUI not available, starting CLI mode")
                run_cli_mode(ai_core, unsupervised_learning)
        else:
            run_cli_mode(ai_core, unsupervised_learning)
            
    except ImportError as e:
        print(f"âŒ Import error: {e}")
        print("ğŸ’¡ Please install dependencies:")
        print("   pip install numpy pandas scikit-learn tensorflow requests")
        return 1
    except Exception as e:
        print(f"âŒ System error: {e}")
        return 1
    
    return 0


def run_cli_mode(ai_core, unsupervised_learning):
    """Run the system in CLI mode"""
    print("\nğŸ¯ CLI Mode - AI Penetration Testing")
    print("=" * 40)
    
    while True:
        print("\nAvailable options:")
        print("1. ğŸ” Quick Scan")
        print("2. ğŸ¤– Smart Attack")
        print("3. ğŸ§  Pattern Discovery")
        print("4. ğŸ“Š Show Statistics")
        print("5. ğŸš¨ Anomaly Detection")
        print("6. ğŸ“ˆ Performance Analysis")
        print("7. ğŸ’¾ Save Models")
        print("8. âŒ Exit")
        
        try:
            choice = input("\nSelect option (1-8): ").strip()
            
            if choice == "1":
                quick_scan(ai_core)
            elif choice == "2":
                smart_attack(ai_core)
            elif choice == "3":
                pattern_discovery(unsupervised_learning, ai_core)
            elif choice == "4":
                show_statistics(ai_core)
            elif choice == "5":
                anomaly_detection(unsupervised_learning, ai_core)
            elif choice == "6":
                performance_analysis(ai_core)
            elif choice == "7":
                save_models(ai_core)
            elif choice == "8":
                print("ğŸ‘‹ Goodbye!")
                break
            else:
                print("âŒ Invalid option. Please select 1-8.")
                
        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ Goodbye!")
            break
        except Exception as e:
            print(f"âŒ Error: {e}")


def quick_scan(ai_core):
    """Perform a quick scan"""
    print("\nğŸ” Quick Scan Mode")
    target = input("Enter target URL: ").strip()
    
    if not target:
        print("âŒ Please enter a target URL")
        return
    
    print(f"ğŸ“¡ Scanning {target}...")
    
    # Simulate scan
    import requests
    try:
        response = requests.get(target, timeout=10)
        print(f"âœ… Target is reachable (Status: {response.status_code})")
        
        # Basic analysis
        print(f"ğŸ“Š Response size: {len(response.text)} bytes")
        print(f"â±ï¸  Response time: {response.elapsed.total_seconds():.2f}s")
        
        # Check for common vulnerabilities
        if "error" in response.text.lower():
            print("âš ï¸  Potential error disclosure detected")
        
        if "admin" in response.text.lower():
            print("âš ï¸  Admin interface reference found")
            
    except requests.RequestException as e:
        print(f"âŒ Error scanning target: {e}")


def smart_attack(ai_core):
    """Perform AI-powered smart attack"""
    print("\nğŸ¤– Smart Attack Mode")
    target = input("Enter target URL: ").strip()
    
    if not target:
        print("âŒ Please enter a target URL")
        return
    
    print("Available attack types:")
    for i, attack_type in enumerate(AttackType, 1):
        print(f"{i}. {attack_type.value}")
    
    try:
        choice = int(input("Select attack type (1-5): ")) - 1
        attack_type = list(AttackType)[choice]
    except (ValueError, IndexError):
        print("âŒ Invalid choice")
        return
    
    print(f"ğŸ¯ Starting {attack_type.value} attack on {target}...")
    
    # Perform attack
    max_attempts = 10
    previous_failures = []
    
    for attempt in range(max_attempts):
        # Generate adaptive payload
        payload = ai_core.generate_adaptive_payload(target, attack_type, previous_failures)
        
        # Predict success
        confidence = ai_core.predict_success(target, payload, attack_type)
        
        print(f"ğŸ¯ Attempt {attempt + 1}: Confidence = {confidence:.2f}")
        
        # Simulate attack
        success = confidence > 0.7
        
        # Create result
        result = AttackResult(
            attack_type=attack_type,
            target=target,
            payload=payload,
            success=success,
            response_code=200 if success else 403,
            response_time=0.5,
            confidence_score=confidence
        )
        
        # Learn from result
        ai_core.learn_from_result(result)
        
        if success:
            print(f"âœ… Attack successful! Payload: {payload}")
            break
        else:
            previous_failures.append(payload)
            print(f"âŒ Attack failed. Learning...")
        
        time.sleep(0.5)
    
    print("ğŸ¯ Smart attack completed!")


def pattern_discovery(unsupervised_learning, ai_core):
    """Discover patterns using unsupervised learning"""
    print("\nğŸ§  Pattern Discovery Mode")
    
    # Get attack history for analysis
    attack_data = []
    for result in ai_core.attack_history:
        attack_data.append({
            'target': result.target,
            'payload': result.payload,
            'success': result.success,
            'response_code': result.response_code,
            'response_time': result.response_time,
            'attack_type': result.attack_type.value
        })
    
    if not attack_data:
        print("âš ï¸  No data available for pattern analysis")
        return
    
    print(f"ğŸ“Š Analyzing {len(attack_data)} data points...")
    
    # Generate insights
    insights = unsupervised_learning.generate_insights(attack_data)
    
    print("ğŸ“ˆ Pattern Analysis Results:")
    print("-" * 30)
    
    if 'key_findings' in insights:
        for finding in insights['key_findings']:
            print(f"ğŸ’¡ {finding}")
    
    if 'patterns' in insights and 'patterns' in insights['patterns']:
        patterns = insights['patterns']['patterns']
        if 'success_rate' in patterns:
            print(f"ğŸ“Š Success Rate: {patterns['success_rate']:.2%}")
    
    print("âœ… Pattern discovery completed!")


def show_statistics(ai_core):
    """Show AI performance statistics"""
    print("\nğŸ“Š AI Performance Statistics")
    print("-" * 30)
    
    stats = ai_core.get_statistics()
    
    for key, value in stats.items():
        if isinstance(value, float):
            print(f"{key}: {value:.3f}")
        else:
            print(f"{key}: {value}")


def anomaly_detection(unsupervised_learning, ai_core):
    """Detect anomalies in attack data"""
    print("\nğŸš¨ Anomaly Detection Mode")
    
    # Get attack history
    attack_data = []
    for result in ai_core.attack_history:
        attack_data.append({
            'target': result.target,
            'payload': result.payload,
            'success': result.success,
            'response_code': result.response_code,
            'response_time': result.response_time,
            'attack_type': result.attack_type.value
        })
    
    if not attack_data:
        print("âš ï¸  No data available for anomaly detection")
        return
    
    print(f"ğŸ” Analyzing {len(attack_data)} data points for anomalies...")
    
    # Detect anomalies
    anomaly_results = unsupervised_learning.detect_anomalies(attack_data)
    
    print("ğŸš¨ Anomaly Detection Results:")
    print("-" * 30)
    
    for method, result in anomaly_results.items():
        if 'anomaly_ratio' in result:
            print(f"{method}: {result['anomaly_ratio']:.2%} anomalies detected")
    
    print("âœ… Anomaly detection completed!")


def performance_analysis(ai_core):
    """Analyze system performance"""
    print("\nğŸ“ˆ Performance Analysis")
    print("-" * 30)
    
    stats = ai_core.get_statistics()
    
    if 'success_rate' in stats:
        success_rate = stats['success_rate']
        if success_rate > 0.8:
            print("ğŸ¯ Excellent performance!")
        elif success_rate > 0.6:
            print("âœ… Good performance")
        elif success_rate > 0.4:
            print("âš ï¸  Moderate performance")
        else:
            print("âŒ Poor performance - needs improvement")
    
    if 'patterns_learned' in stats:
        print(f"ğŸ§  Patterns learned: {stats['patterns_learned']}")
    
    if 'models_trained' in stats:
        print(f"ğŸ¤– Models trained: {stats['models_trained']}")


def save_models(ai_core):
    """Save trained models"""
    print("\nğŸ’¾ Saving Models")
    print("-" * 30)
    
    try:
        ai_core._save_models()
        print("âœ… Models saved successfully!")
    except Exception as e:
        print(f"âŒ Error saving models: {e}")


if __name__ == "__main__":
    sys.exit(main()) 